<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Board</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <h2>Edit Board</h2>
        <div class="status">Click on any square to change the piece</div>
        <form id="boardForm" method="POST" action="/board-edit">
            <div class="board" id="board">
                <!-- Board squares will be generated here -->
            </div>
            <div class="controls">
                <button type="submit" class="button" style="background-color: #28a745;">✓ Apply</button>
                <button type="button" class="button" style="background-color: #17a2b8;" onclick="loadCurrentBoard()">↻
                    Reload</button>
                <button type="button" class="button" style="background-color: #dc3545;" onclick="clearBoard()">✕
                    Clear</button>
            </div>
        </form>
        <a href="/board-view" class="button">View Board</a>
        <a href="/" class="back-button">OpenChess Home</a>
    </div>
    <script>
        // Map piece letters to a single symbol (same for white/black)
        const PIECE_SYMBOL = {
            r: '♖',
            n: '♘',
            b: '♗',
            q: '♕',
            k: '♔',
            p: '♙'
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.square').forEach(square => {
                const select = square.querySelector('select');
                if (!select) return;

                // create overlay span to show only the symbol on the board
                let overlay = square.querySelector('.select-symbol');
                if (!overlay) {
                    overlay = document.createElement('span');
                    overlay.className = 'select-symbol';
                    square.appendChild(overlay);
                }

                // color options based on optgroup (white = first group)
                select.querySelectorAll('optgroup').forEach((group, index) => {
                    const color = index === 0 ? '#ffffff' : '#222222';
                    group.querySelectorAll('option').forEach(opt => opt.style.color = color);
                });

                const updateDisplay = () => {
                    const val = select.value; // e.g. 'R' or 'r' or ''
                    if (!val) {
                        overlay.textContent = '';
                        return;
                    }
                    const symbol = PIECE_SYMBOL[val.toLowerCase()] || '';
                    overlay.textContent = symbol;
                    // uppercase = white, lowercase = black
                    overlay.style.color = (val === val.toUpperCase()) ? '#ffffff' : '#111111';
                };

                select.addEventListener('change', updateDisplay);
                // initialize current state
                updateDisplay();
            });
        });

        function loadCurrentBoard() {
            fetch('/board').then(response => response.json()).then(data => {
                if (data.valid) {
                    for (let row = 0; row < 8; row++) {
                        for (let col = 0; col < 8; col++) {
                            const piece = data.board[row][col] || '';
                            const select = document.getElementById('r' + row + 'c' + col);
                            select.value = piece;
                            select.dispatchEvent(new Event('change'));
                        }
                    }
                }
            }
            );
        }

        function clearBoard() {
            if (confirm('Clear all pieces from the board?')) {
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const select = document.getElementById('r' + row + 'c' + col);
                        select.value = '';
                        select.dispatchEvent(new Event('change'));
                    }
                }
            }
        }

        function generateBoard() {
            const board = document.getElementById("board");
            board.innerHTML = "";
            const pieceOptions = `<optgroup label="White Pieces"><option value="R">♖ Rook</option><option value="N">♘ Knight</option><option value="B">♗ Bishop</option><option value="Q">♕ Queen</option><option value="K">♔ King</option><option value="P">♙ Pawn</option></optgroup><optgroup label="Black Pieces"><option value="r">♖ Rook</option><option value="n">♘ Knight</option><option value="b">♗ Bishop</option><option value="q">♕ Queen</option><option value="k">♔ King</option><option value="p">♙ Pawn</option><option value="" selected>-</option></optgroup>`;
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const isLight = (r + c) % 2 === 0;
                    const squareClass = isLight ? "light" : "dark";
                    const square = document.createElement("div");
                    square.className = `square ${squareClass}`;
                    const select = document.createElement("select");
                    select.name = `r${r}c${c}`;
                    select.id = `r${r}c${c}`;
                    select.innerHTML = pieceOptions;
                    square.appendChild(select);
                    board.appendChild(square);
                }
            }
        }

        generateBoard();
        loadCurrentBoard();

        // Intercept form submit to handle OK/Not OK response
        const form = document.getElementById('boardForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                params.append(key, value);
            }
            try {
                const resp = await fetch('/board-edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params.toString()
                });
                if (resp.ok) {
                    // Server replied OK → redirect to board view
                    window.location.href = '/board-view';
                } else {
                    // Not OK → warn the user
                    alert('Board update failed. Please try again.');
                }
            } catch (err) {
                alert('Network error while updating board.');
            }
        });
    </script>
</body>

</html>