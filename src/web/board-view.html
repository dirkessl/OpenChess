<html lang>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Board</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <h2>Chess Board</h2>
        <div class="status">Board state: <span id="state-display" style="color: #F44336;">✗ Invalid</span></div>
        <div class="board" id="board">
            <!-- Board squares will be generated here -->
        </div>
        <div class="info">
            <div id="evaluation" style="margin-top: 15px; padding: 15px; background-color: #444; border-radius: 5px;">
                <div
                    style="position: relative; width: 100%; height: 40px; background-color: #333; border: 2px solid #555; border-radius: 5px; overflow: hidden;">
                    <div id="eval-bar"
                        style="position: absolute; top: 0; left: 50%; width: 0%; height: 100%; background: linear-gradient(to right, #F44336 0%, #F44336 50%, #4CAF50 50%, #4CAF50 100%); transition: width 0.3s ease, left 0.3s ease;">
                    </div>
                    <div
                        style="position: absolute; top: 0; left: 50%; width: 2px; height: 100%; background-color: #ec8703; z-index: 2;">
                    </div>
                    <div id="eval-arrow"
                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; z-index: 3; color: #ec8703; transition: left 0.3s ease;">
                        ⬌</div>
                </div>
                <div id="eval-text" style="text-align: center; margin-top: 10px; font-size: 14px; color: #ec8703;">--
                </div>
            </div>
        </div>
        <a href="/board-edit" class="button">Edit Board</a>
        <a href="/" class="back-button">OpenChess Home</a>
    </div>

    <script>
        function generateBoard() {
            const board = document.getElementById("board");
            board.innerHTML = "";
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const isLight = (r + c) % 2 === 0;
                    const squareClass = isLight ? "light" : "dark";
                    const square = document.createElement("div");
                    square.className = `square ${squareClass}`;
                    board.appendChild(square);
                }
            }
        }
        generateBoard();
        // Fetch board state via AJAX for smoother updates
        function updateBoard() {
            fetch('/board').then(response => response.json()).then(data => {
                const stateDisplay = document.getElementById('state-display');
                if (data.valid) {
                    stateDisplay.style.color = '#4CAF50';
                    stateDisplay.textContent = '✓ Valid';
                } else {
                    stateDisplay.style.color = '#F44336';
                    stateDisplay.textContent = '✗ Invalid';
                }
                if (data.valid) {
                    const squares = document.querySelectorAll('.square');
                    let index = 0;
                    for (let row = 0; row < 8; row++) {
                        for (let col = 0; col < 8; col++) {
                            const piece = data.board[row][col];
                            const square = squares[index];
                            if (piece && piece !== '') {
                                const isWhite = piece === piece.toUpperCase();
                                square.innerHTML = '<span class="piece ' + (isWhite ? 'white' : 'black') + '">' + getPieceSymbol(piece) + '</span>';
                            } else {
                                square.innerHTML = '';
                            } index++;
                        }
                    }
                    if (data.evaluation !== undefined) {
                        const evalValue = data.evaluation;
                        const evalInPawns = evalValue.toFixed(2);
                        // Maximum evaluation to display (10 pawns)
                        const maxEval = 10;
                        const clampedEval = Math.max(-maxEval, Math.min(maxEval, evalValue));
                        const percentage = Math.abs(clampedEval) / maxEval * 50;
                        // Max 50% on each side
                        const bar = document.getElementById('eval-bar');
                        const arrow = document.getElementById('eval-arrow');
                        const text = document.getElementById('eval-text');
                        let evalText = '';
                        let arrowSymbol = '⬌';
                        if (evalValue > 0) {
                            bar.style.left = '50%';
                            bar.style.width = percentage + '%';
                            bar.style.background = 'linear-gradient(to right, #ec8703 0%, #4CAF50 100%)';
                            arrow.style.left = (50 + percentage) + '%';
                            arrowSymbol = '→';
                            arrow.style.color = '#4CAF50';
                            evalText = '+' + evalInPawns + ' (White advantage)';
                        } else if (evalValue < 0) {
                            bar.style.left = (50 - percentage) + '%';
                            bar.style.width = percentage + '%';
                            bar.style.background = 'linear-gradient(to right, #F44336 0%, #ec8703 100%)';
                            arrow.style.left = (50 - percentage) + '%';
                            arrowSymbol = '←';
                            arrow.style.color = '#F44336';
                            evalText = evalInPawns + ' (Black advantage)';
                        } else {
                            bar.style.left = '50%';
                            bar.style.width = '0%';
                            bar.style.background = '#ec8703';
                            arrow.style.left = '50%';
                            arrowSymbol = '⬌';
                            arrow.style.color = '#ec8703';
                            evalText = '0.00 (Equal)';
                        } arrow.textContent = arrowSymbol;
                        text.textContent = evalText;
                        text.style.color = arrow.style.color;
                    }
                }
            });
        }

        function getPieceSymbol(piece) {
            if (!piece) return '';
            const symbols = { 'R': '♖', 'N': '♘', 'B': '♗', 'Q': '♕', 'K': '♔', 'P': '♙', 'r': '♜', 'n': '♞', 'b': '♝', 'q': '♛', 'k': '♚', 'p': '♟' };
            return symbols[piece.toUpperCase()] || piece;
        }

        updateBoard();
        setInterval(updateBoard, 500);
    </script>
</body>

</html>